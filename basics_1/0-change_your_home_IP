#!/usr/bin/env bash

# Active des options de sécurité (stoppe en cas d’erreur, variables non définies interdites, erreurs dans pipes prises en compte)
set -euo pipefail

# Définit l’emplacement du fichier hosts
HOSTS_FILE="/etc/hosts"

# Définit un fichier de sauvegarde avec la date/heure actuelle
BACKUP="/etc/hosts.bak.$(date +%s)"

# Vérifie si l’utilisateur est root
if [[ $EUID -ne 0 ]]; then
  # Affiche un message d’erreur si on n’est pas root
  echo "Ce script doit être exécuté avec sudo." >&2
  # Quitte le script avec un code d’erreur
  exit 1
fi

# Fait une copie de sauvegarde du fichier hosts
cp -a "$HOSTS_FILE" "$BACKUP"

# Crée un fichier temporaire pour stocker le nouveau contenu
tmp="$(mktemp)"

# Utilise awk pour filtrer le contenu et enlever les mauvaises lignes
awk '
  # Début du script awk : désactive la casse
  BEGIN{IGNORECASE=0}
  {
    # Ignore toute ligne contenant facebook.com
    if ($0 ~ /(^|[[:space:]])facebook\.com([[:space:]]|$)/) next
    # Ignore toute ligne où localhost est déjà mappé sur une IP 127.x.x.x
    if ($0 ~ /^[[:space:]]*127\.[0-9]+\.[0-9]+\.[0-9]+[[:space:]].*\blocalhost\b/) next
    # Sinon conserve la ligne
    print
  }
' "$HOSTS_FILE" > "$tmp"

# Ajoute nos nouvelles règles dans le fichier temporaire
{
  # Définit localhost sur 127.0.0.2
  echo "127.0.0.2 localhost"
  # Définit facebook.com sur 8.8.8.8
  echo "8.8.8.8 facebook.com"
} >> "$tmp"

# Remplace le fichier hosts par la version modifiée
install -m 0644 "$tmp" "$HOSTS_FILE"

# Supprime le fichier temporaire
rm -f "$tmp"

# Affiche que la mise à jour est faite
echo "Mise à jour effectuée. Sauvegarde : $BACKUP"
# Rappel du nouveau mapping
echo "localhost -> 127.0.0.2"
echo "facebook.com -> 8.8.8.8"
